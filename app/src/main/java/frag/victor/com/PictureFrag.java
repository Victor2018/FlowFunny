package frag.victor.com;import android.content.Context;import android.content.Intent;import android.os.Bundle;import android.os.Handler;import android.os.Message;import android.support.v4.app.Fragment;import android.support.v4.widget.SwipeRefreshLayout;import android.support.v7.widget.GridLayoutManager;import android.support.v7.widget.LinearLayoutManager;import android.support.v7.widget.OrientationHelper;import android.support.v7.widget.RecyclerView;import android.support.v7.widget.RecyclerView.OnScrollListener;import android.support.v7.widget.StaggeredGridLayoutManager;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Toast;import java.util.ArrayList;import java.util.List;import java.util.Observable;import java.util.Observer;import adapter.victor.com.PictureAdapter;import data.victor.com.PictureContentData;import data.victor.com.PictureData;import flowfunny.victor.com.R;import mode.victor.com.DataObservable;import util.victor.com.Constant;import util.victor.com.HttpRequestHelper;import view.victor.com.CircularProgress;public class PictureFrag extends Fragment implements Observer,SwipeRefreshLayout.OnRefreshListener {	private String TAG = "PictureFrag";	private CircularProgress mCpProgress;	private SwipeRefreshLayout swipeRefreshLayout;	private RecyclerView mRvPicture;	private PictureAdapter pictureAdapter;	private List<PictureContentData> pictureContentDatas = new ArrayList<>();	private HttpRequestHelper mHttpRequestHelper;	private  int currentPage = 1;//当前页数	private LinearLayoutManager linearLayoutManager;	private GridLayoutManager gridLayoutManager;	private StaggeredGridLayoutManager staggeredGridLayoutManager;	private boolean isLoading;	private Context mContext;	Handler mHandler = new Handler(){		@Override		public void handleMessage(Message msg) {			switch (msg.what){				case Constant.Msg.REQUEST_SUCCESS:					isLoading = false;					swipeRefreshLayout.setRefreshing(false);					mCpProgress.setVisibility(View.GONE);					List<PictureContentData> curPageDatas = (List<PictureContentData>) msg.obj;					pictureContentDatas.addAll(curPageDatas);					pictureAdapter.setPictureContentDatas(pictureContentDatas);					if(curPageDatas.size() < Constant.PAGE_SIZE){						pictureAdapter.setFooterVisible(false);					} else {						pictureAdapter.setFooterVisible(true);					}					break;				case Constant.Msg.REQUEST_SUCCESS_NO_DATA:					mCpProgress.setVisibility(View.GONE);					if (currentPage == 1) {						pictureContentDatas.clear();						pictureAdapter.setFooterVisible(false);						pictureAdapter.notifyDataSetChanged();					}					if (mContext != null){						Toast.makeText(mContext,"服务器没有数据！",Toast.LENGTH_SHORT).show();					}					break;				case Constant.Msg.REQUEST_FAILED:					mCpProgress.setVisibility(View.GONE);					if (currentPage == 1) {						pictureContentDatas.clear();						pictureAdapter.setFooterVisible(false);						pictureAdapter.notifyDataSetChanged();					}					if (mContext != null){						Toast.makeText(mContext,"访问服务器失败！",Toast.LENGTH_SHORT).show();					}					break;				case Constant.Msg.PARSING_EXCEPTION:					mCpProgress.setVisibility(View.GONE);					if (currentPage == 1) {						pictureContentDatas.clear();						pictureAdapter.setFooterVisible(false);					}					if (mContext != null){						Toast.makeText(mContext,"数据解析异常！",Toast.LENGTH_SHORT).show();					}					break;				case Constant.Msg.NETWORK_ERROR:					mCpProgress.setVisibility(View.GONE);					if (currentPage == 1) {						pictureContentDatas.clear();						pictureAdapter.setFooterVisible(false);					}					if (mContext != null){						Toast.makeText(mContext,"网络错误，请检查网络是否连接！",Toast.LENGTH_SHORT).show();					}					break;				case Constant.Msg.SOCKET_TIME_OUT:					mCpProgress.setVisibility(View.GONE);					if (currentPage == 1) {						pictureContentDatas.clear();						pictureAdapter.setFooterVisible(false);					}					if (mContext != null){						Toast.makeText(mContext,"访问服务器超时，请重试！",Toast.LENGTH_SHORT).show();					}					break;				case Constant.Action.SHARE_PICTURE:					Intent intentshare = new Intent(Intent.ACTION_SEND);					intentshare.setType("text/plain")							.putExtra(Intent.EXTRA_SUBJECT, "分享")							.putExtra(Intent.EXTRA_TEXT,"给你分享一个美女：" + msg.obj);					Intent.createChooser(intentshare, "分享");					startActivity(intentshare);					break;			}		}	};	@Override	public void onActivityCreated(Bundle savedInstanceState) {		super.onActivityCreated(savedInstanceState);		mContext = getContext();	}	@Override	public View onCreateView(LayoutInflater inflater, ViewGroup container,Bundle savedInstanceState) {		View view = inflater.inflate(R.layout.frag_picture,container, false);		initialize (view);		DataObservable.getInstance().addObserver(this);		return view;	}	private void initialize (View view) {		mCpProgress = (CircularProgress) view.findViewById(R.id.cp_progress);		swipeRefreshLayout = (SwipeRefreshLayout) view.findViewById(R.id.srl_fresh);		mRvPicture = (RecyclerView) view.findViewById(R.id.rv_picture);		//设置 进度条的颜色变化，最多可以设置4种颜色		swipeRefreshLayout.setColorSchemeResources(android.R.color.holo_purple, android.R.color.holo_blue_bright,				android.R.color.holo_orange_light, android.R.color.holo_red_light);		swipeRefreshLayout.setOnRefreshListener(this);		linearLayoutManager = new LinearLayoutManager(getContext());//这里用线性显示 类似于listview		gridLayoutManager = new GridLayoutManager(getContext(), 2);//这里用线性宫格显示 类似于grid view		staggeredGridLayoutManager = new StaggeredGridLayoutManager(2, OrientationHelper.VERTICAL);//这里用线性宫格显示 类似于瀑布流		//设置头部及底部View占据整行空间		gridLayoutManager.setSpanSizeLookup(new GridLayoutManager.SpanSizeLookup() {			@Override			public int getSpanSize(int position) {				return (pictureAdapter.isHeaderView(position) || pictureAdapter.isBottomView(position)) ? gridLayoutManager.getSpanCount() : 1;			}		});		mRvPicture.setLayoutManager(linearLayoutManager);		pictureAdapter = new PictureAdapter(getContext());		pictureAdapter.setPictureContentDatas(pictureContentDatas);		pictureAdapter.setHeaderVisible(false);		pictureAdapter.setFooterVisible(false);		mRvPicture.setAdapter(pictureAdapter);		mRvPicture.addOnScrollListener(new OnScrollListener() {			@Override			public void onScrollStateChanged(RecyclerView recyclerView, int newState) {				super.onScrollStateChanged(recyclerView, newState);			}			@Override			public void onScrolled(RecyclerView recyclerView, int dx, int dy) {				super.onScrolled(recyclerView, dx, dy);				int lastVisibleItemPosition = linearLayoutManager.findLastVisibleItemPosition();				if (lastVisibleItemPosition + 1 == pictureAdapter.getItemCount()) {					boolean isRefreshing = swipeRefreshLayout.isRefreshing();					if (isRefreshing) {						pictureContentDatas.clear();						pictureAdapter.notifyDataSetChanged();						return;					}					if (!isLoading) {						isLoading = true;						currentPage ++;						requestPictureDatas();					}				}			}		});		mHttpRequestHelper = new HttpRequestHelper(getContext());		requestPictureDatas();	}	@Override	public void update(Observable observable, Object data) {		if (data instanceof PictureData) {			PictureData pictureData = (PictureData) data;			int status = pictureData.getStatus();			Message msg = new Message();			switch (status) {				case Constant.Msg.REQUEST_SUCCESS:					msg.what = Constant.Msg.REQUEST_SUCCESS;					msg.obj = pictureData.getPictureContentDatas();					break;				case Constant.Msg.REQUEST_SUCCESS_NO_DATA:					msg.what = Constant.Msg.REQUEST_SUCCESS_NO_DATA;					break;				case Constant.Msg.REQUEST_FAILED:					msg.what = Constant.Msg.REQUEST_FAILED;					break;				case Constant.Msg.PARSING_EXCEPTION:					msg.what = Constant.Msg.PARSING_EXCEPTION;					break;				case Constant.Msg.NETWORK_ERROR:					msg.what = Constant.Msg.NETWORK_ERROR;					break;				case Constant.Msg.SOCKET_TIME_OUT:					msg.what = Constant.Msg.SOCKET_TIME_OUT;					break;			}			mHandler.sendMessage(msg);		} else if (data instanceof Bundle) {			Bundle bundle = (Bundle) data;			int action = bundle.getInt(Constant.ACTION_KEY);			if (action == Constant.Action.SHARE_PICTURE) {				String imgUrl = ((Bundle) data).getString(Constant.INTENT_DATA_KEY);				Message msg = new Message();				msg.what = Constant.Action.SHARE_PICTURE;				msg.obj = imgUrl;				mHandler.sendMessage(msg);			}		}	}	private void onLoad() {//		mLvFunny.stopRefresh();//		mLvFunny.stopLoadMore();//		mLvFunny.setRefreshTime(DateUtil.getTodayTime());		swipeRefreshLayout.setRefreshing(true);	}	/*@Override	public void onRefresh() {		picUrls.clear();		currentPage --;		if (currentPage < 1){			currentPage = 1;		}		requestPictureDatas();		onLoad();	}*/	/*@Override	public void onLoadMore() {		picUrls.clear();		currentPage ++;		requestPictureDatas();		onLoad();	}*/	private void requestPictureDatas () {		if (mHttpRequestHelper != null) {			mCpProgress.setVisibility(View.VISIBLE);			String requestUrl = String.format(Constant.GANK_URL,Constant.PAGE_SIZE,currentPage);			mHttpRequestHelper.sendRequestWithParms(Constant.Msg.PICTURE_REQUEST, requestUrl);		}	}	@Override	public void onDestroy() {		if (mHttpRequestHelper != null) {			mHttpRequestHelper.onDestroy();		}		super.onDestroy();	}	@Override	public void onRefresh() {		pictureContentDatas.clear();		currentPage --;		if (currentPage < 1){			currentPage = 1;		}		requestPictureDatas();		onLoad();	}}